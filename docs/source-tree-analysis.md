# Source Tree Analysis

## Overview

This document provides an annotated directory structure of the `climate_indices` project, highlighting critical paths, entry points, and module purposes for AI-assisted development.

## Project Root Structure

```
climate_indices/
â”œâ”€â”€ ğŸ“„ Configuration Files
â”‚   â”œâ”€â”€ pyproject.toml          â† PEP 517 build config, dependencies, tool settings
â”‚   â”œâ”€â”€ uv.lock                  â† Reproducible dependency lock (generated by uv)
â”‚   â””â”€â”€ Dockerfile               â† Container image definition (Python 3.11-slim)
â”‚
â”œâ”€â”€ ğŸ“š Documentation
â”‚   â”œâ”€â”€ README.md                â† GitHub landing page, quick start
â”‚   â”œâ”€â”€ CONTRIBUTING.md          â† Development workflow, coding standards
â”‚   â”œâ”€â”€ CHANGELOG.md             â† Version history, breaking changes
â”‚   â”œâ”€â”€ RELEASE_NOTES.md         â† Release-specific notes
â”‚   â”œâ”€â”€ LICENSE                  â† BSD 3-Clause license
â”‚   â””â”€â”€ DISCLAIMER               â† US Government software disclaimer
â”‚
â”œâ”€â”€ ğŸ¯ Source Code
â”‚   â””â”€â”€ src/                     â† Production code (see detailed breakdown below)
â”‚
â”œâ”€â”€ ğŸ§ª Tests
â”‚   â””â”€â”€ tests/                   â† Test suite (26 test files, see detailed breakdown)
â”‚
â”œâ”€â”€ ğŸ“– Sphinx Documentation
â”‚   â””â”€â”€ docs/                    â† ReadTheDocs RST + AI-readable Markdown
â”‚
â”œâ”€â”€ ğŸ“¦ Distribution
â”‚   â””â”€â”€ dist/                    â† Build artifacts (wheel + sdist)
â”‚
â”œâ”€â”€ ğŸ““ Notebooks
â”‚   â””â”€â”€ notebooks/               â† Jupyter notebooks for examples and exploration
â”‚
â”œâ”€â”€ ğŸ–¼ï¸  Assets
â”‚   â””â”€â”€ assets/                  â† Images, reference data
â”‚
â”œâ”€â”€ ğŸ”§ BMAD Workflow (AI Development Support)
â”‚   â””â”€â”€ _bmad/                   â† BMAD configuration and workflows
â”‚
â””â”€â”€ ğŸš€ CI/CD
    â””â”€â”€ .github/workflows/       â† GitHub Actions (unit tests, releases, benchmarks)
```

## Critical Directory: `src/climate_indices/` (14 modules)

### Entry Point Layer
```
src/climate_indices/
â”œâ”€â”€ ğŸšª CLI Entry Points
â”‚   â”œâ”€â”€ __main__.py              ğŸ”´ CRITICAL - Full-featured CLI
â”‚   â”‚   â”œâ”€â”€ Entry: climate_indices, process_climate_indices
â”‚   â”‚   â”œâ”€â”€ Lines: 1826
â”‚   â”‚   â”œâ”€â”€ Purpose: Batch processing of NetCDF datasets (all indices)
â”‚   â”‚   â”œâ”€â”€ Features:
â”‚   â”‚   â”‚   â”œâ”€â”€ Multiprocessing pool for gridded data
â”‚   â”‚   â”‚   â”œâ”€â”€ Shared memory arrays for efficiency
â”‚   â”‚   â”‚   â”œâ”€â”€ NetCDF dimension validation
â”‚   â”‚   â”‚   â”œâ”€â”€ Input type detection (grid/divisions/timeseries)
â”‚   â”‚   â”‚   â””â”€â”€ Unit conversion (mm, inches, Celsius, Fahrenheit, Kelvin)
â”‚   â”‚   â””â”€â”€ Indices: SPI, SPEI, PET, Palmer (all variants), PNP
â”‚   â”‚
â”‚   â””â”€â”€ __spi__.py               ğŸŸ¡ HIGH PRIORITY - Specialized SPI CLI
â”‚       â”œâ”€â”€ Entry: spi
â”‚       â”œâ”€â”€ Lines: 1478
â”‚       â”œâ”€â”€ Purpose: SPI computation with parameter caching
â”‚       â”œâ”€â”€ Features:
â”‚       â”‚   â”œâ”€â”€ Distribution fitting parameter save/load (NetCDF)
â”‚       â”‚   â”œâ”€â”€ Parallel fitting and SPI computation
â”‚       â”‚   â”œâ”€â”€ Gamma and Pearson Type III distributions
â”‚       â”‚   â””â”€â”€ Multiprocessing parallelization
â”‚       â””â”€â”€ Use Case: Reusable fitting parameters for operational systems
```

### Public API Layer
```
â”œâ”€â”€ ğŸŒ Public APIs
â”‚   â”œâ”€â”€ __init__.py              ğŸ”´ CRITICAL - Package exports
â”‚   â”‚   â”œâ”€â”€ Lines: 43
â”‚   â”‚   â”œâ”€â”€ Purpose: Define public API surface
â”‚   â”‚   â”œâ”€â”€ Exports:
â”‚   â”‚   â”‚   â”œâ”€â”€ Modern API: spi(), spei() from typed_public_api
â”‚   â”‚   â”‚   â”œâ”€â”€ xarray utils: xarray_adapter(), detect_input_type()
â”‚   â”‚   â”‚   â”œâ”€â”€ PET functions: pet_thornthwaite(), pet_hargreaves()
â”‚   â”‚   â”‚   â”œâ”€â”€ CF metadata: CFAttributes, CF_METADATA
â”‚   â”‚   â”‚   â”œâ”€â”€ Exceptions: ClimateIndicesError, ClimateIndicesWarning
â”‚   â”‚   â”‚   â”œâ”€â”€ Logging: configure_logging()
â”‚   â”‚   â”‚   â””â”€â”€ Version: __version__
â”‚   â”‚   â””â”€â”€ AI Note: This is the contract with users; changes require major version bump
â”‚   â”‚
â”‚   â”œâ”€â”€ typed_public_api.py      ğŸŸ¢ NEW IN 2.2.0 - Strict mypy API
â”‚   â”‚   â”œâ”€â”€ Lines: 210
â”‚   â”‚   â”œâ”€â”€ Purpose: Type-safe wrappers for SPI/SPEI
â”‚   â”‚   â”œâ”€â”€ Features:
â”‚   â”‚   â”‚   â”œâ”€â”€ Full mypy --strict compliance
â”‚   â”‚   â”‚   â”œâ”€â”€ Keyword-only arguments (prevents positional errors)
â”‚   â”‚   â”‚   â”œâ”€â”€ Runtime type validation
â”‚   â”‚   â”‚   â””â”€â”€ Overloaded signatures for numpy/xarray inputs
â”‚   â”‚   â”œâ”€â”€ Functions:
â”‚   â”‚   â”‚   â”œâ”€â”€ spi() - Type-safe SPI computation
â”‚   â”‚   â”‚   â””â”€â”€ spei() - Type-safe SPEI computation
â”‚   â”‚   â””â”€â”€ AI Note: Preferred API for new code; strict type checking enforced
â”‚   â”‚
â”‚   â”œâ”€â”€ xarray_adapter.py        ğŸ”´ CRITICAL (EXPANDED IN 2.2.0)
â”‚   â”‚   â”œâ”€â”€ Lines: 1417 (was ~400 in 2.1.0)
â”‚   â”‚   â”œâ”€â”€ Purpose: CF-compliant xarray interface
â”‚   â”‚   â”œâ”€â”€ Features:
â”‚   â”‚   â”‚   â”œâ”€â”€ Input type detection (DataArray, Dataset, ndarray)
â”‚   â”‚   â”‚   â”œâ”€â”€ Coordinate validation and alignment
â”‚   â”‚   â”‚   â”œâ”€â”€ CF metadata preservation and generation
â”‚   â”‚   â”‚   â”œâ”€â”€ Dask array support with chunking validation
â”‚   â”‚   â”‚   â”œâ”€â”€ PET computation (Thornthwaite, Hargreaves)
â”‚   â”‚   â”‚   â””â”€â”€ Graceful degradation (xarray â†’ numpy â†’ xarray)
â”‚   â”‚   â”œâ”€â”€ Key Functions:
â”‚   â”‚   â”‚   â”œâ”€â”€ xarray_adapter() - Universal wrapper
â”‚   â”‚   â”‚   â”œâ”€â”€ pet_thornthwaite() - Monthly PET from temp + lat
â”‚   â”‚   â”‚   â”œâ”€â”€ pet_hargreaves() - Daily PET from tmin/tmax + lat
â”‚   â”‚   â”‚   â”œâ”€â”€ detect_input_type() - Type detection utility
â”‚   â”‚   â”‚   â””â”€â”€ _validate_* family - Input validation helpers
â”‚   â”‚   â”œâ”€â”€ CF Metadata: CFAttributes dataclass, CF_METADATA dict
â”‚   â”‚   â””â”€â”€ AI Note: Primary entry point for modern xarray workflows
â”‚   â”‚
â”‚   â””â”€â”€ indices.py               ğŸŸ¡ HIGH PRIORITY - Legacy numpy API
â”‚       â”œâ”€â”€ Lines: 701
â”‚       â”œâ”€â”€ Purpose: Backward-compatible numpy interface
â”‚       â”œâ”€â”€ Stability: MUST remain stable (breaking changes require major version)
â”‚       â”œâ”€â”€ Functions:
â”‚       â”‚   â”œâ”€â”€ spi() - Standardized Precipitation Index
â”‚       â”‚   â”œâ”€â”€ spei() - Standardized Precipitation Evapotranspiration Index
â”‚       â”‚   â”œâ”€â”€ pet() - Potential Evapotranspiration (Thornthwaite)
â”‚       â”‚   â”œâ”€â”€ percentage_of_normal() - PNP index
â”‚       â”‚   â””â”€â”€ Distribution enum (gamma, pearson)
â”‚       â””â”€â”€ AI Note: Do NOT modify signatures; use xarray_adapter for new features
```

### Computation Layer
```
â”œâ”€â”€ ğŸ§® Core Computation
â”‚   â”œâ”€â”€ compute.py               ğŸ”´ CRITICAL - Mathematical core
â”‚   â”‚   â”œâ”€â”€ Lines: 1127
â”‚   â”‚   â”œâ”€â”€ Purpose: Core algorithms for climate index calculation
â”‚   â”‚   â”œâ”€â”€ Key Functions:
â”‚   â”‚   â”‚   â”œâ”€â”€ scale_values() - Rolling sum for temporal scaling
â”‚   â”‚   â”‚   â”œâ”€â”€ sum_to_scale() - Optimized sliding window summation
â”‚   â”‚   â”‚   â”œâ”€â”€ gamma_parameters() - Gamma distribution fitting (MoM)
â”‚   â”‚   â”‚   â”œâ”€â”€ pearson_parameters() - Pearson Type III fitting (L-moments)
â”‚   â”‚   â”‚   â”œâ”€â”€ transform_fitted_gamma() - CDF â†’ standard normal (gamma)
â”‚   â”‚   â”‚   â”œâ”€â”€ transform_fitted_pearson() - CDF â†’ standard normal (Pearson)
â”‚   â”‚   â”‚   â””â”€â”€ Periodicity enum (monthly=12, daily=366)
â”‚   â”‚   â”œâ”€â”€ Algorithm Details:
â”‚   â”‚   â”‚   â”œâ”€â”€ Gamma: Method of moments (alpha, beta)
â”‚   â”‚   â”‚   â”œâ”€â”€ Pearson: L-moments (loc, scale, skew) via lmoments.py
â”‚   â”‚   â”‚   â”œâ”€â”€ CDF transformation: scipy.stats.gamma/pearson3
â”‚   â”‚   â”‚   â””â”€â”€ Inverse normal: scipy.stats.norm.ppf()
â”‚   â”‚   â””â”€â”€ AI Note: Pure functions, heavily tested, ~100% coverage
â”‚   â”‚
â”‚   â””â”€â”€ palmer.py                ğŸŸ¡ HIGH PRIORITY - Palmer indices
â”‚       â”œâ”€â”€ Lines: 806
â”‚       â”œâ”€â”€ Purpose: Palmer Drought Index family
â”‚       â”œâ”€â”€ Indices Computed:
â”‚       â”‚   â”œâ”€â”€ PDSI - Palmer Drought Severity Index
â”‚       â”‚   â”œâ”€â”€ PHDI - Palmer Hydrological Drought Index
â”‚       â”‚   â”œâ”€â”€ PMDI - Palmer Modified Drought Index
â”‚       â”‚   â”œâ”€â”€ ZINDEX - Palmer Z-Index
â”‚       â”‚   â””â”€â”€ scPDSI - Self-calibrated Palmer
â”‚       â””â”€â”€ AI Note: Complex stateful algorithm; requires AWC (available water capacity)
```

### Mathematical Layer
```
â”œâ”€â”€ ğŸ“ Math/Statistics
â”‚   â”œâ”€â”€ eto.py                   ğŸŸ¡ HIGH PRIORITY - PET methods
â”‚   â”‚   â”œâ”€â”€ Lines: 416
â”‚   â”‚   â”œâ”€â”€ Purpose: Potential Evapotranspiration computation
â”‚   â”‚   â”œâ”€â”€ Methods:
â”‚   â”‚   â”‚   â”œâ”€â”€ Thornthwaite (1948) - Monthly PET from temperature + latitude
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Heat index computation
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Day length adjustment (latitude-dependent)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Suitable for monthly data
â”‚   â”‚   â”‚   â””â”€â”€ Hargreaves (1985) - Daily PET from temp range + radiation
â”‚   â”‚   â”‚       â”œâ”€â”€ Requires tmin, tmax, latitude
â”‚   â”‚   â”‚       â”œâ”€â”€ Extraterrestrial radiation calculation
â”‚   â”‚   â”‚       â””â”€â”€ Suitable for daily data
â”‚   â”‚   â””â”€â”€ AI Note: Self-contained, no upper-layer dependencies
â”‚   â”‚
â”‚   â””â”€â”€ lmoments.py              ğŸŸ¢ SPECIALTY - L-moments
â”‚       â”œâ”€â”€ Lines: 94
â”‚       â”œâ”€â”€ Purpose: L-moments for robust Pearson Type III fitting
â”‚       â”œâ”€â”€ Algorithm: Hosking (1990) L-moments
â”‚       â””â”€â”€ AI Note: Used by compute.pearson_parameters()
```

### Infrastructure Layer
```
â””â”€â”€ ğŸ—ï¸  Infrastructure
    â”œâ”€â”€ exceptions.py            ğŸ”´ CRITICAL - Exception hierarchy
    â”‚   â”œâ”€â”€ Lines: 324
    â”‚   â”œâ”€â”€ Purpose: Structured error handling
    â”‚   â”œâ”€â”€ Base: ClimateIndicesError (catch-all)
    â”‚   â”œâ”€â”€ Computation Errors:
    â”‚   â”‚   â”œâ”€â”€ DistributionFittingError (base)
    â”‚   â”‚   â”œâ”€â”€ InsufficientDataError (< 10 non-zero values)
    â”‚   â”‚   â””â”€â”€ PearsonFittingError (numerical issues)
    â”‚   â”œâ”€â”€ Validation Errors:
    â”‚   â”‚   â”œâ”€â”€ DimensionMismatchError (shape issues)
    â”‚   â”‚   â”œâ”€â”€ CoordinateValidationError (coord issues)
    â”‚   â”‚   â”œâ”€â”€ InputTypeError (type mismatch)
    â”‚   â”‚   â””â”€â”€ InvalidArgumentError (value out of range)
    â”‚   â”œâ”€â”€ Warnings:
    â”‚   â”‚   â”œâ”€â”€ MissingDataWarning (>20% missing in calibration)
    â”‚   â”‚   â”œâ”€â”€ ShortCalibrationWarning (<30 years)
    â”‚   â”‚   â”œâ”€â”€ GoodnessOfFitWarning (poor distribution fit)
    â”‚   â”‚   â””â”€â”€ InputAlignmentWarning (time steps dropped)
    â”‚   â””â”€â”€ AI Note: All exceptions carry context attributes for debugging
    â”‚
    â”œâ”€â”€ logging_config.py        ğŸŸ¢ UTILITY - Structured logging
    â”‚   â”œâ”€â”€ Lines: 76
    â”‚   â”œâ”€â”€ Purpose: Configure structlog for library
    â”‚   â”œâ”€â”€ Features:
    â”‚   â”‚   â”œâ”€â”€ JSON serialization for file logs
    â”‚   â”‚   â”œâ”€â”€ Human-readable console logs with colors
    â”‚   â”‚   â”œâ”€â”€ Context binding for request tracing
    â”‚   â”‚   â””â”€â”€ configure_logging() public function
    â”‚   â””â”€â”€ AI Note: Call configure_logging() before library use
    â”‚
    â”œâ”€â”€ utils.py                 ğŸŸ¡ HIGH PRIORITY - Utilities
    â”‚   â”œâ”€â”€ Lines: 396
    â”‚   â”œâ”€â”€ Purpose: Cross-cutting utility functions
    â”‚   â”œâ”€â”€ Key Functions:
    â”‚   â”‚   â”œâ”€â”€ Calendar conversions:
    â”‚   â”‚   â”‚   â”œâ”€â”€ transform_to_366day() - Gregorian â†’ 366-day calendar
    â”‚   â”‚   â”‚   â””â”€â”€ transform_to_gregorian() - 366-day â†’ Gregorian
    â”‚   â”‚   â”œâ”€â”€ Data validation:
    â”‚   â”‚   â”‚   â”œâ”€â”€ is_data_valid() - Check array validity (not all-NaN)
    â”‚   â”‚   â”‚   â””â”€â”€ get_tolerance() - Floating-point tolerance for coords
    â”‚   â”‚   â”œâ”€â”€ Array reshaping:
    â”‚   â”‚   â”‚   â”œâ”€â”€ reshape_to_2d() - Flatten to 2D for processing
    â”‚   â”‚   â”‚   â””â”€â”€ reshape_to_divs() - Reshape for climate divisions
    â”‚   â”‚   â””â”€â”€ Periodicity helpers:
    â”‚   â”‚       â””â”€â”€ gregorian_length_as_366day() - Convert lengths
    â”‚   â””â”€â”€ AI Note: Pure functions, widely used across codebase
    â”‚
    â””â”€â”€ performance.py           ğŸŸ¢ NEW IN 2.2.0 - Performance tracking
        â”œâ”€â”€ Lines: 112
        â”œâ”€â”€ Purpose: Observability and profiling
        â”œâ”€â”€ Features:
        â”‚   â”œâ”€â”€ @measure_execution_time decorator
        â”‚   â”œâ”€â”€ Memory usage tracking
        â”‚   â””â”€â”€ Computation duration logging
        â””â”€â”€ AI Note: Use for identifying bottlenecks
```

## Critical Directory: `tests/` (26 test files)

### Test Organization
```
tests/
â”œâ”€â”€ ğŸ“‹ Fixture Definition
â”‚   â”œâ”€â”€ conftest.py              ğŸ”´ CRITICAL - Shared fixtures
â”‚   â”‚   â”œâ”€â”€ Lines: 1005
â”‚   â”‚   â”œâ”€â”€ Scope: Session-scoped for performance
â”‚   â”‚   â”œâ”€â”€ Fixture Categories:
â”‚   â”‚   â”‚   â”œâ”€â”€ Numpy arrays (precips, temps, PET)
â”‚   â”‚   â”‚   â”œâ”€â”€ xarray DataArrays (1D, 3D, Dask-backed)
â”‚   â”‚   â”‚   â”œâ”€â”€ Edge cases (zeros, NaNs, non-monotonic time)
â”‚   â”‚   â”‚   â”œâ”€â”€ Benchmark fixtures (performance testing)
â”‚   â”‚   â”‚   â””â”€â”€ Constants (calibration years, latitude)
â”‚   â”‚   â””â”€â”€ AI Note: Add new fixtures here for test reuse
â”‚   â”‚
â”‚   â””â”€â”€ fixture/                 ğŸŸ¢ Test data storage
â”‚       â”œâ”€â”€ *.npy                â† Numpy arrays (precip, temp, SPI/SPEI results)
â”‚       â”œâ”€â”€ palmer_awc.json      â† Available water capacity data
â”‚       â””â”€â”€ palmer/              â† Palmer index reference outputs
â”‚
â”œâ”€â”€ ğŸ§ª Core Functionality Tests
â”‚   â”œâ”€â”€ test_indices.py          ğŸ”´ CRITICAL - Legacy API tests
â”‚   â”œâ”€â”€ test_compute.py          ğŸ”´ CRITICAL - Algorithm tests
â”‚   â”œâ”€â”€ test_xarray_adapter.py   ğŸ”´ CRITICAL (EXPANDED) - Modern API tests
â”‚   â”œâ”€â”€ test_typed_public_api.py ğŸŸ¢ NEW - Strict typing tests
â”‚   â”œâ”€â”€ test_eto.py              ğŸŸ¡ PET computation tests
â”‚   â””â”€â”€ test_palmer.py           ğŸŸ¡ Palmer indices regression
â”‚
â”œâ”€â”€ âœ… Quality Assurance
â”‚   â”œâ”€â”€ test_backward_compat.py  ğŸ”´ CRITICAL - API stability
â”‚   â”œâ”€â”€ test_xarray_equivalence.py ğŸŸ¡ numpy â†” xarray parity
â”‚   â”œâ”€â”€ test_property_based.py   ğŸŸ¢ Hypothesis invariants
â”‚   â””â”€â”€ test_type_checking.py    ğŸŸ¢ mypy runtime validation
â”‚
â”œâ”€â”€ ğŸ›¡ï¸  Validation and Errors
â”‚   â”œâ”€â”€ test_exceptions.py       ğŸŸ¡ Exception hierarchy
â”‚   â”œâ”€â”€ test_input_validation.py ğŸŸ¡ Input validation
â”‚   â”œâ”€â”€ test_metadata_validation.py ğŸŸ¢ CF metadata
â”‚   â”œâ”€â”€ test_computation_errors.py ğŸŸ¢ Error conditions
â”‚   â”œâ”€â”€ test_data_quality_warnings.py ğŸŸ¢ Warning behavior
â”‚   â””â”€â”€ test_input_type_detection.py ğŸŸ¢ Type detection
â”‚
â”œâ”€â”€ ğŸ“Š Observability
â”‚   â”œâ”€â”€ test_logging.py          ğŸŸ¢ Structured logging
â”‚   â”œâ”€â”€ test_logging_config.py   ğŸŸ¢ Logger configuration
â”‚   â”œâ”€â”€ test_error_context_logging.py ğŸŸ¢ Error context
â”‚   â”œâ”€â”€ test_calculation_event_logging.py ğŸŸ¢ Calc events
â”‚   â””â”€â”€ test_performance_metrics.py ğŸŸ¢ Performance tracking
â”‚
â”œâ”€â”€ âš¡ Performance (Benchmarks)
â”‚   â”œâ”€â”€ test_benchmark_overhead.py ğŸŸ¢ xarray vs numpy overhead
â”‚   â”œâ”€â”€ test_benchmark_chunked.py ğŸŸ¢ Dask chunking
â”‚   â””â”€â”€ test_benchmark_memory.py ğŸŸ¢ Memory profiling
â”‚
â””â”€â”€ ğŸ”§ Utilities
    â”œâ”€â”€ test_utils.py            ğŸŸ¡ Utility functions
    â””â”€â”€ test_zero_precipitation_fix.py ğŸŸ¢ Specific bug fix
```

### Test Markers
```python
# In pyproject.toml [tool.pytest.ini_options]
markers = [
    "benchmark: performance tests (deselect with '-m \"not benchmark\"')",
    "slow: slow tests for CI (deselect with '-m \"not slow\"')",
]
# Default: benchmarks excluded (addopts = "-m 'not benchmark'")
```

### Running Tests
```bash
# All tests (excluding benchmarks)
uv run pytest

# Include benchmarks
uv run pytest -m benchmark

# Specific category
uv run pytest tests/test_xarray_adapter.py -v

# With coverage
uv run pytest --cov=src --cov-report=html
```

## Critical Directory: `docs/`

### Documentation Structure
```
docs/
â”œâ”€â”€ ğŸ“– Sphinx Documentation (ReadTheDocs)
â”‚   â”œâ”€â”€ conf.py                  ğŸ”´ Sphinx configuration
â”‚   â”œâ”€â”€ index.rst                ğŸ”´ Main landing page
â”‚   â”œâ”€â”€ reference.rst            ğŸŸ¡ API reference (autodoc)
â”‚   â”œâ”€â”€ pypi_release.rst         ğŸŸ¢ PyPI release guide
â”‚   â”œâ”€â”€ Makefile, make.bat       ğŸŸ¢ Build automation
â”‚   â”œâ”€â”€ requirements.txt         ğŸŸ¢ Doc dependencies
â”‚   â””â”€â”€ source/                  ğŸŸ¢ Generated API docs
â”‚       â”œâ”€â”€ modules.rst
â”‚       â””â”€â”€ tests.rst
â”‚
â””â”€â”€ ğŸ“ AI-Readable Documentation (BMAD Format, NEW)
    â”œâ”€â”€ index.md                 ğŸ”´ Master index (this will be generated)
    â”œâ”€â”€ project-overview.md      ğŸ”´ Executive summary, classification
    â”œâ”€â”€ architecture.md          ğŸ”´ Technical architecture
    â”œâ”€â”€ source-tree-analysis.md  ğŸ”´ This file
    â”œâ”€â”€ component-inventory.md   ğŸŸ¡ Module catalog (to be generated)
    â”œâ”€â”€ development-guide.md     ğŸŸ¡ Setup, build, test (to be generated)
    â”œâ”€â”€ deployment-guide.md      ğŸŸ¡ Docker, CI/CD (to be generated)
    â””â”€â”€ contribution-guide.md    ğŸŸ¡ Contributing guidelines (to be generated)
```

## Critical Directory: `.github/workflows/`

### CI/CD Pipelines
```
.github/workflows/
â”œâ”€â”€ unit-tests-workflow.yml      ğŸ”´ CRITICAL - Test matrix
â”‚   â”œâ”€â”€ Trigger: Push, PR
â”‚   â”œâ”€â”€ Matrix: Python 3.10-3.13 Ã— ubuntu-latest
â”‚   â”œâ”€â”€ Steps: uv sync â†’ pytest â†’ codecov
â”‚   â””â”€â”€ Purpose: Ensure compatibility across Python versions
â”‚
â”œâ”€â”€ release.yml                  ğŸŸ¡ Automated PyPI releases
â”‚   â”œâ”€â”€ Trigger: Git tag (vX.Y.Z)
â”‚   â”œâ”€â”€ Steps: Build (hatchling) â†’ Publish (PyPI) â†’ GitHub Release
â”‚   â””â”€â”€ Purpose: Streamline release process
â”‚
â””â”€â”€ benchmarks.yml               ğŸŸ¢ NEW IN 2.2.0 - Performance tracking
    â”œâ”€â”€ Trigger: Manual dispatch, scheduled (weekly)
    â”œâ”€â”€ Steps: pytest -m benchmark â†’ compare â†’ artifact
    â””â”€â”€ Purpose: Detect performance regressions
```

## Supporting Directories

### Notebooks (`notebooks/`)
```
notebooks/
â”œâ”€â”€ spi_simple.ipynb             ğŸŸ¢ Simple SPI example
â”œâ”€â”€ visualize_precip_spi.ipynb   ğŸŸ¢ Visualization examples
â”œâ”€â”€ generate_fitting_parameters_nclimgrid.ipynb ğŸŸ¢ Parameter generation
â”œâ”€â”€ muitprocess_spi_nclimgrid.ipynb ğŸŸ¢ Multiprocessing example
â””â”€â”€ concurrent_shared_memory_example.ipynb ğŸŸ¢ Shared memory pattern
```

### Assets (`assets/`)
```
assets/
â”œâ”€â”€ Global_Monthly_SPI.jpg       ğŸŸ¢ Example SPI visualization
â””â”€â”€ EDDI_code_GMU/               ğŸŸ¢ Reference EDDI implementation
```

### BMAD Workflows (`_bmad/`)
```
_bmad/                           ğŸŸ¢ AI development support (NEW)
â”œâ”€â”€ _config/                     â† BMAD configuration
â”‚   â”œâ”€â”€ manifest.yaml            â† Project manifest
â”‚   â”œâ”€â”€ agent-manifest.csv       â† Agent definitions
â”‚   â”œâ”€â”€ files-manifest.csv       â† File inventory
â”‚   â”œâ”€â”€ task-manifest.csv        â† Task definitions
â”‚   â””â”€â”€ workflow-manifest.csv    â† Workflow definitions
â”‚
â”œâ”€â”€ _memory/                     â† Memory for AI agents
â”‚   â”œâ”€â”€ storyteller-sidecar/     â† Story context
â”‚   â””â”€â”€ tech-writer-sidecar/     â† Documentation context
â”‚
â”œâ”€â”€ core/                        â† Core BMAD workflows
â”œâ”€â”€ bmb/                         â† BMB module workflows
â”œâ”€â”€ bmm/                         â† BMM module workflows
â”œâ”€â”€ cis/                         â† CIS module workflows
â””â”€â”€ tea/                         â† Test architecture workflows
```

## Module Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLI Layer                           â”‚
â”‚  __main__.py â”€â”€â”€â”                                           â”‚
â”‚  __spi__.py â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
                  â”‚                                     â”‚
                  â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Public API Layer                       â”‚
â”‚  typed_public_api.py â”€â”€â”                                    â”‚
â”‚  xarray_adapter.py â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  indices.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚             â”‚   â”‚
                         â–¼             â–¼   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Computation Layer                         â”‚
â”‚  compute.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  palmer.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚   â”‚
                            â–¼   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Math/Statistics Layer                        â”‚
â”‚  eto.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  lmoments.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                      â”‚
                        â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Infrastructure Layer                        â”‚
â”‚  utils.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  logging_config.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  exceptions.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  performance.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dependency Rules
1. **No circular dependencies**: Strictly enforced layered architecture
2. **Infrastructure has no upper-layer imports**: Pure utilities
3. **Math/Stats layer independent**: Could be extracted to separate package
4. **Public API wraps Computation**: xarray_adapter uses indices internally
5. **CLI depends on all layers**: Imports from all layers as needed

## Legend

### Priority Markers
- ğŸ”´ **CRITICAL**: Core functionality, breaking changes require careful review
- ğŸŸ¡ **HIGH PRIORITY**: Important functionality, frequent modification
- ğŸŸ¢ **STANDARD**: Supporting functionality, stable code

### Status Markers
- ğŸ†• **NEW IN 2.2.0**: Recently added functionality
- ğŸ”„ **EXPANDED IN 2.2.0**: Significantly enhanced
- âœ… **STABLE**: Backward compatibility guaranteed
- âš ï¸ **DEPRECATED**: Scheduled for removal (see deprecations/)

## AI Development Quick Reference

### Most Frequently Modified Files
1. `xarray_adapter.py` - Modern API enhancements
2. `compute.py` - Algorithm improvements
3. `exceptions.py` - New error types
4. `test_xarray_adapter.py` - Modern API tests
5. `conftest.py` - New test fixtures

### Read-Only Files (Do NOT Modify)
1. `indices.py` - Backward compatibility guarantee
2. `uv.lock` - Generated by uv (use `uv lock` to update)
3. `fixture/*.npy` - Regression test data
4. `docs/source/` - Sphinx-generated files

### Entry Points for Common Tasks

| Task | Start Here | Related Files |
|------|-----------|---------------|
| Add new index | `compute.py`, `indices.py`, `xarray_adapter.py` | Test files |
| Fix CLI bug | `__main__.py` or `__spi__.py` | Integration testing |
| Add validation | `xarray_adapter.py`, `exceptions.py` | `test_input_validation.py` |
| Performance issue | `compute.py`, benchmark tests | `performance.py` |
| New distribution | `compute.py`, `indices.py` | `test_compute.py` |

---

**Next Steps**: See [component-inventory.md](./component-inventory.md) for detailed module descriptions, [development-guide.md](./development-guide.md) for setup instructions, and [architecture.md](./architecture.md) for design patterns.
